# Bitcoin Mining Analytics Platform - Migrations Directory

This directory contains SQL migration files for the Bitcoin Mining Analytics platform's database schema.

## Migration Files

Migration files are automatically generated by Drizzle ORM and are used to track database schema changes. Each migration file is a SQL script that can be run to update the database schema.

## Structure

Migration files follow this naming convention:

```
YYYYMMDDHHMMSS_migration_name.sql
```

For example:
- `20250301120000_create_initial_tables.sql`
- `20250302143000_add_indexes.sql`
- `20250305092500_add_bitcoin_calculations.sql`

## Running Migrations

Migrations are typically run using the migration script:

```bash
npx tsx scripts/migrations/run_migration.ts
```

This script handles:
1. Connecting to the database
2. Running pending migrations in order
3. Tracking which migrations have been run
4. Handling errors during migration

## Creating Migrations

New migrations are automatically generated when you modify the database schema in `db/schema.ts` and run:

```bash
npm run db:generate
```

This command uses Drizzle Kit to compare the current database schema with the schema defined in code and generate necessary migration files.

## Migration Best Practices

1. **Always Test Migrations**: Test migrations on a development database before running them in production
2. **Back Up Data**: Always back up the database before running migrations
3. **Avoid Destructive Changes**: Where possible, avoid dropping tables or columns (use ALTER instead)
4. **Include Down Migrations**: Consider adding down migrations for critical changes
5. **Document Complex Migrations**: Add comments to migration files explaining complex changes

## Manual Migrations

For complex migrations that can't be automatically generated, you can create manual migration files:

1. Create a new SQL file in this directory with the proper naming convention
2. Add your SQL statements to the file
3. Run the migration script to apply the changes

## Tracking Migrations

The database includes a `_drizzle_migrations` table that tracks which migrations have been run:

```sql
CREATE TABLE IF NOT EXISTS _drizzle_migrations (
  id SERIAL PRIMARY KEY,
  hash text NOT NULL,
  created_at timestamptz DEFAULT now()
);
```

This table ensures that migrations are only run once.

## Common Migration Types

### Adding a New Table

```sql
CREATE TABLE table_name (
  id SERIAL PRIMARY KEY,
  column_name data_type constraints,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_table_name_column_name ON table_name(column_name);
```

### Adding a New Column

```sql
ALTER TABLE table_name
ADD COLUMN column_name data_type constraints;
```

### Modifying a Column

```sql
ALTER TABLE table_name
ALTER COLUMN column_name TYPE new_data_type;
```

### Adding an Index

```sql
CREATE INDEX idx_table_name_column_name ON table_name(column_name);
```

## Troubleshooting

If you encounter issues with migrations:

1. Check the database error logs
2. Verify that the `DATABASE_URL` environment variable is correct
3. Ensure you have the necessary permissions to modify the database schema
4. Check for conflicting migrations or schema changes
5. Look for syntax errors in the migration SQL