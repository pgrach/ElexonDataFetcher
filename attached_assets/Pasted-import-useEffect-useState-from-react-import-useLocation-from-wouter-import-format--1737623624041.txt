import { useEffect, useState } from "react";
import { useLocation } from "wouter";
import { format, startOfMonth } from "date-fns";
import { useQuery } from "@tanstack/react-query";
import { fetchDailySummary } from "@/lib/api";
import { fetchBitcoinPrice } from "@/lib/services/bitcoinPrice";
import { DatePicker } from "@/components/DatePicker";
import { EnergyChart } from "@/components/EnergyChart";
import { Stats } from "@/components/Stats";
import { TopFarmsDialog } from "@/components/TopFarmsDialog";
import { InfoCard } from "@/components/InfoCard";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { useToast } from "@/hooks/use-toast";
import { Wind, TreeDeciduous, Bitcoin, PoundSterling } from "lucide-react";

type MinerModel = "S9" | "S19J_PRO" | "M20S";

// Add the monthly data fetching function
const fetchMonthlySummary = async (date: string) => {
  const response = await fetch(`/api/summary/monthly/${date}`);
  if (!response.ok) {
    throw new Error('Failed to fetch monthly summary');
  }
  return response.json();
};

export default function Home() {
  const [location, navigate] = useLocation();
  const { toast } = useToast();
  const [selectedMinerModel, setSelectedMinerModel] =
    useState<MinerModel>("S19J_PRO");

  // Get date from URL or use today
  const urlDate = location.split("/")[1];
  const initialDate = urlDate ? new Date(urlDate) : new Date();
  const formattedDate = format(initialDate, "yyyy-MM-dd");

  const {
    data: summaryData,
    error: summaryError,
    isLoading: isSummaryLoading,
  } = useQuery({
    queryKey: [`/api/summary/${formattedDate}`, selectedMinerModel],
    queryFn: () => fetchDailySummary(formattedDate, selectedMinerModel),
  });

  const { data: priceData, error: priceError } = useQuery({
    queryKey: [`/api/bitcoin/price`, formattedDate],
    queryFn: () => fetchBitcoinPrice(new Date(formattedDate)),
    enabled: !!formattedDate,
  });

  const {
    data: monthlySummary,
    error: monthlyError,
    isLoading: isMonthlyLoading,
  } = useQuery({
    queryKey: [`/api/summary/monthly/${formattedDate}`],
    queryFn: () => fetchMonthlySummary(formattedDate),
    enabled: !!formattedDate,
  });

  useEffect(() => {
    if (summaryError || priceError || monthlyError) {
      toast({
        variant: "destructive",
        title: "Error",
        description: "Failed to load data",
      });
    }
  }, [summaryError, priceError, monthlyError, toast]);

  const handleDateChange = (date: Date) => {
    navigate(`/${format(date, "yyyy-MM-dd")}`);
  };

  const handleMinerModelChange = (model: MinerModel) => {
    setSelectedMinerModel(model);
  };

  const isZeroCurtailment =
    !isSummaryLoading && summaryData?.totalCurtailedEnergy === 0;

  return (
    <div className="min-h-screen bg-gradient-to-b from-sky-100 to-white dark:from-sky-900 dark:to-gray-900">
      <div className="container mx-auto p-4 space-y-8">
        {/* Header */}
        <header className="py-6">
          <div className="flex flex-col gap-6">
            <div>
              <h1 className="text-4xl font-bold text-sky-900 dark:text-sky-100 flex items-center gap-2">
                <Wind className="h-8 w-8 text-sky-500" />
                CurtailCoin
              </h1>
              <p className="text-xl text-sky-700 dark:text-sky-300">
                Turning Britain's Unused Wind Power into Bitcoin
              </p>
            </div>
            <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
              <DatePicker date={initialDate} onDateChange={handleDateChange} />
              <TopFarmsDialog date={formattedDate} minerModel={selectedMinerModel} />
            </div>
          </div>
        </header>

        {/* Zero Curtailment Message */}
        {isZeroCurtailment && !summaryError && (
          <div className="bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border shadow-sm rounded-lg p-4">
            <p className="text-lg text-center">
              <span className="font-semibold text-muted-foreground">
                No wind curtailment detected today.
              </span>
              <span className="block text-sm text-muted-foreground mt-1">
                This can occur during periods of low wind generation or when the
                grid can handle all available wind power.
              </span>
            </p>
          </div>
        )}

        <Stats
          totalCurtailedEnergy={summaryData?.totalCurtailedEnergy ?? 0}
          totalPotentialBtc={summaryData?.totalPotentialBtc ?? 0}
          totalPayment={summaryData?.totalPayment ?? 0}
          monthlyPayment={monthlySummary?.totalPayment}
          monthlyCurtailedEnergy={monthlySummary?.totalCurtailedEnergy}
          btcPrice={priceData}
          isLoading={isSummaryLoading || isMonthlyLoading}
          error={!!summaryError}
          selectedMinerModel={selectedMinerModel}
          onMinerModelChange={handleMinerModelChange}
        />

        {summaryData && !summaryError && (
          <Card className="shadow-lg">
            <CardHeader>
              <CardTitle className="text-xl text-sky-900 dark:text-sky-100">
                Hourly Breakdown
              </CardTitle>
            </CardHeader>
            <CardContent>
              <EnergyChart data={summaryData.hourlyData} />
            </CardContent>
          </Card>
        )}

        {/* Info Cards Section */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <InfoCard
            title="What is Curtailed Energy?"
            content="Curtailed energy is the excess wind power that's generated but not used due to grid limitations or low demand. Instead of wasting this energy, we can use it for Bitcoin mining."
            icon={Wind}
          />
          <InfoCard
            title="Double Financial Impact"
            content="Wind curtailment creates two financial burdens: First, consumers pay for curtailed energy through 'Curtailment Payments' to wind farms (ca.Â£50/MWh under CfD and ROCs schemes). Second, this paid-for clean energy goes unused instead of being converted into valuable Bitcoin - a missed opportunity for both consumers and the environment."
            icon={PoundSterling}
          />
          <InfoCard
            title="Environmental Impact"
            content="By utilising curtailed energy for Bitcoin mining, we're making use of clean energy that would otherwise go to waste. This helps in reducing the carbon footprint of Bitcoin mining while maximising the value of renewable energy infrastructure."
            icon={TreeDeciduous}
          />
        </div>

        <footer className="text-center text-sm text-sky-700 dark:text-sky-300 py-4">
          <p>
            Want to explore Bitcoin mining potential further?{" "}
            <a
              href="https://aidala.uk/dashboard"
              target="_blank"
              rel="noopener noreferrer"
              className="text-sky-500 hover:underline"
            >
              Try our Bitcoin Mining Calculator
            </a>
          </p>
        </footer>
      </div>
    </div>
  );
}